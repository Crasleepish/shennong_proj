---

# ✅ 更新后的组合优化方案（修正版）

---

## 🎯 总体目标

构建一个适用于非CAPM市场（如A股）的组合优化系统，融合：

* **因子回归逻辑**（无需市场均衡假设）
* **机器学习预测 α 排序**
* **Kalman Filter 时间加权**
* **贝叶斯后验融合观点**
* **CVaR 优化控制尾部风险**

---

## 📦 数据结构

| 数据源         | 用途                    |
| ----------- | --------------------- |
| ETF 历史收益    | 计算 α & 验证组合表现         |
| 因子历史收益      | 用于预测未来收益率             |
| ETF 因子暴露（β） | 用于构造 μ\_prior 和 μ\_ML |
| 宏观数据        | 做机器学习模型输入特征           |

---

## 🧠 一｜先验收益率（μ\_prior）构造

> 不再使用 BL 中的市场均衡 π
> 而是使用 **ETF 各因子暴露 × 因子历史收益率均值**

### ✅ 处理方式：

$$
\mu_i^{\text{prior}} = \sum_f \beta_{i,f} \cdot \bar{r}_f
$$

* 其中 $\bar{r}_f$ 为因子 $f$ 的历史收益率（可加权平均）

📌 使用 **Kalman Filter** 对 $\bar{r}_f$ 进行**时间加权更新**，提升对当前 regime 的反应：

* 新数据权重大，历史数据衰减；
* 处理噪声扰动，提高时序平滑性。

---

## 🤖 二｜机器学习预测 α 排序

> 使用 XGBoost 回归预测未来 20天的 因子收益率

### ✅ 步骤：

1. **XGBoost 回归模型**预测每个因子 $f$ 的未来收益率 $\hat{r}_f$
2. 对每个资产计算预测值：

   $$
   \hat{\mu}_i^{\text{ML}} = \sum_f \beta_{i,f} \cdot \hat{r}_f
   $$
3. 将 $\hat{\mu}_i^{\text{ML}}$ 排序，形成观点：

   $$
   \text{view rank}(\mu_i)
   $$

📌 不直接使用数值，而是 **将横截面排序作为观点**（排序更稳健，抗尺度漂移）

---

## 🧮 三｜贝叶斯后验融合观点

> 保留 Black–Litterman 的贝叶斯更新框架，但不使用 CAPM 的 π

### ✅ 思路：

* $\mu^{\text{prior}}$：由历史因子收益率 + β × Kalman Filter 构成
* $\hat{\mu}^{\text{ML}}$：由机器学习预测后排序而来，映射为相对观点（Pμ = q）
* 构造观点矩阵 $P$、q、Ω：

  * $P$：比较性矩阵（如 ETF1 > ETF2 → \[1, -1, 0, …]）
  * $q$：排序得分（可设为等间隔 \[0.03, 0.02, …]）
  * $\Omega$：由模型残差、排序稳定性、回测误差构造（非固定值）

> 最终后验：

$$
\mu_{\text{post}} = \left[(\tau\Sigma)^{-1} + P^\top\Omega^{-1}P\right]^{-1}
\left[(\tau\Sigma)^{-1} \mu^{\text{prior}} + P^\top\Omega^{-1} q\right]
$$

---

## 📉 四｜CVaR 优化：风险约束下的收益最优

> 控制尾部风险（98% CVaR ≤ 5%）前提下，最大化期望收益或夏普比率

### ✅ 步骤：

1. 模拟收益场景（历史+随机扰动）
2. 对每个组合权重构造：

   * 损失函数：$L = -w^\top R$
   * CVaR：

     $$
     \text{CVaR}_{\alpha}(w) = \min_{\beta} \left\{ \beta + \frac{1}{1-\alpha} \cdot \mathbb{E}[(L - \beta)^+] \right\}
     $$
3. 优化目标：

   * 最大化 $w^\top \mu_{\text{post}}$
   * s.t. CVaR ≤ κ，long-only, turnover 控制等约束

---

## ✅ 优势总结（修正版）

| 维度            | 优势              |
| ------------- | --------------- |
| 不依赖 CAPM      | 更贴合 A 股/非有效市场环境 |
| 保留贝叶斯结构       | 融合观点 × 控制不确定性   |
| XGBoost 排序    | 稳健、抗漂移，解释性强     |
| CVaR 风控       | 控制尾部风险，符合实盘约束   |
| Kalman Filter | 保留时序信号权重，稳健先验   |
| 模块解耦          | 预测、融合、优化各模块清晰可调 |

---

## **v2.0 方案更新（相对于原 v1.0 项目计划）**

本次更新反映了近期对因子标签体系、收益预测方法、BL 观点结构和黄金资产处理方式的重大调整。以下为新增内容。

---

## **1. 标签（Label）体系更新**

原方案使用 Gaussian 假设 + μ±ασ 作为三分类标签边界。
现替换为：

### ✔ **Rolling 分位数标签**

* 使用 **rolling window（建议 500 天）** 的分位数（20%、50%、80%）对未来 20 日收益率进行划分；
* 自动适应因子收益分布的非平稳性；
* 不再依赖正态分布假设。

> 覆盖的任务：SMB、HML、QMJ、10YBond（用于 ER_stat 部分）

---

## **2. 黄金（GOLD）收益预测重构**

黄金未来收益预测不再使用：

* ML（XGBoost）
* BL（Black–Litterman）

改为：

### ✔ **Rolling 分位数 + LLM 主观判断**

* 使用期货结构（前 6 个高流动性合约 + CASH）与 CFTC 持仓信号；
* 由 LLM 输出“方向性档位”（strong/mild bear/bull/neutral）；
* Rolling 分位数提供 **对应档位的客观收益区间均值**；
* 最终黄金预期收益 **= 纯主观观点输出（LLM → 档位 → ER_roll）**；
* 不进入 BL；黄金被视为 **纯战术资产 / 对冲资产**。

---

## **3. SMB / HML / QMJ 三因子的收益预测重构**

三因子不再训练 ML 模型，因为：

* 技术/量价类特征无法捕捉风格因子；
* ML 泛化性差、过拟合严重；
* 统计特征反而更稳定、更可解释。

现采用：

### ✔ **Rolling 分位数 + 全概率公式 → ER_stat**

步骤：

1. 用 rolling 分位数得到 softprob（P(-), P(0), P(+)）
2. 计算对应三个区间附加衰减权重后的历史未来收益均值（label_to_ret）
3. 全概率公式得到期望收益：

[
ER_{\text{stat}} = \sum_{k} p_k \cdot \text{ret}_k
]

### ✔ ER_stat 作为 BL 的观点 q

* 因为这类因子具有长期风险溢价；
* BL 的先验（长期均衡）与 rolling（局部 regime）融合更稳健。

---

## **4. MKT 因子继续使用 ML**

MKT 模型保持不变：

* 使用 XGBoost 分类；
* softprob → label_to_ret → ER_ml；
* ER_ml 作为 BL 观点（q）；
* 原因：MKT 吸收宏观 regime、波动率 regime，非线性信号更明显。

---

## **5. 10YBond：推出“ML + Rolling”混合框架**

与 SMB/HML/QMJ 不同，10YBond：

* 可预测性更强（ML 有一定 edge）
* 但同时收益结构非常宏观 + regime 变化大，需要统计稳定性

因此改为：

### ✔ **ER_mix = α · ER_ml + (1 – α) · ER_stat**

建议：

* α ∈ [0.2, 0.4]
* ER_ml 捕捉近期非线性
* ER_stat 捕捉中长期 regime 分布特征

### ✔ ER_mix 作为 BL 的观点（q）

---

## **6. Black–Litterman（BL）观点协方差 Ω 的改进**

原 `omega = predicted_factor_variance` 会导致：

* 视图过度自信
* 模型噪声被误认为“预测误差很小”

现更新为：

### ✔ **视图方差 = (放大系数×预测方差) 与先验方差混合**

[
\omega_i = \alpha \cdot \sigma_{\text{prior},i}^2
+ (1 - \alpha) \cdot c \cdot \text{pred_var}_i
]

* 推荐 `c = 3–5`
* 推荐 `α = 0.3–0.6`
* 更合理地衰减 noisy 观点的影响，提高稳定性


# 《项目计划》V3.0 —— 组合视图构造与风险管理模块更新方案

本次更新（V3.0）在保持现有 Black–Litterman（BL）框架主干逻辑不变的前提下，对 **因子观点构造、模型置信度校准、风格拥挤风险、黄金资产风险控制** 等部分进行了系统性简化与结构升级。目标是：

* **减少自由度**、提升模型稳健性；
* **避免信息重复计入**；
* **在极端市场 regime 下提升风险控制能力**；
* 保持整体架构未来可扩展性。

以下内容为本次更新的详细方案。

---

# 1. 总体原则与设计理念

V3.0 的核心原则如下：

1. **观点的构造统一基于绝对期望收益（abs ER），不再采用“ER_pred − mu_prior”的相对观点方式。**
   → 全部因子与黄金的观点均表示为“预期收益的绝对水平”。

2. → MKT 的观点仅来自 ML（XGBoost softprob）并通过“模型置信度”调节观点方差。

3. **因子（SMB/HML/QMJ）在极端拥挤 regime 下降低相关风格的有效风险预算。**

4. **所有“风险缩放器（scaler）”均为工程化的风险控制模块，不追求 BL 理论纯度，但追求稳定性与可解释性。**

---

# 2. 因子观点（Views）构造逻辑

以下因子均为：
**MKT、SMB、HML、QMJ、10YBOND**

统一输出：

* **ER_factor[f]**（绝对期望收益）
* **omega_factor[f]**（观点方差）

并进入 BL 视图矩阵。

## 2.1 MKT（大盘因子）

### 数据来源

* ML 模型（XGBoost 多分类 → softprob → ER_ml）

### 观点构造

[
ER_{MKT} = ER_{MKT}^{ml}
]

### 观点方差（omega）由模型置信度决定

不再根据技术信号或人工判断，而完全根据 **XGBoost 验证集 loss 的相对水平** 调节。

步骤：

1. 对过去 N 次滚动训练得到验证集 loss 序列：{loss₁, loss₂, …, lossₙ}
2. 计算均值 μ_L 与标准差 σ_L
3. 当前训练的 loss = loss_t
4. 标准化：

[
z_t = \frac{loss_t - \mu_L}{\sigma_L + \epsilon}
]

5. 置信度（越低表示模型越差）：

[
c_t = \mathrm{clip}(\exp(-a \cdot \max(z_t,0)), c_{min}, 1)
]

建议默认：

* a = 0.7
* c_min = 0.1

6. 写入 BL 的观点方差：

[
\omega_{MKT} = \frac{\sigma^2_{\text{prior},MKT}}{c_t + \epsilon}
]

→ 模型效果差 → c 小 → ω 大 → BL 退回先验。

---

## 2.2 SMB / HML / QMJ（风格因子）

### 观点构造

依旧使用：

* 长期窗口 payoff + 时间衰减
* 短期窗口 softprob
* 二者融合得到 ER_factor[f]

[
ER_f = \alpha \cdot ER^{ml}_f + (1-\alpha)\cdot ER^{stat}_f
]

（可根据情况决定是否对 SMB/HML/QMJ 使用 ML；若无 ML，则使用纯 payoff/stat。）

### 观点方差

**V3.0 不再对 SMB/HML/QMJ 的 ω 进行额外风险放大。**
统一采用：

[
\omega_f = \sigma^2_{\text{prior}, f}
]

---

## 2.3 10YBOND（利率因子）

沿用原始逻辑：

[
ER_{10Y} = \alpha \cdot ER^{ml} + (1-\alpha) \cdot ER^{stat}
]

并用 **与 MKT 相同的模型置信度机制调整 ω**：

[
\omega_{10Y} = \frac{\sigma^2_{\text{prior},10Y}}{c_t + \epsilon}
]

---

### 3. 风格拥挤（Style Crowding）风控模块

V3.0 中的风格拥挤模块只保留一个简洁且工程友好的逻辑：

> **当某个因子最近一段时间（例如近 12 个月）的表现相对于自身历史分布变得极端时，认为该风格处于高拥挤或极端 regime，相应降低对该因子历史观点（长期 payoff/stat ER）的置信度，对该因子的进攻性观点进行收缩。**

注意：本模块**不再改动 BL 里的协方差 ω，也不在资产层直接加额外约束**，而是通过对因子 ER 的缩放来间接减弱风格暴露。

#### 3.1 拥挤度评估（基于滚动区间收益）

对因子 ( f \in {\text{SMB}, \text{HML}, \text{QMJ}} )：

1. 使用因子日收益率 ( r_f(t) ) 构造固定长度的滚动区间收益（例如 12 个月，约 (L=252) 个交易日）：

[
R_f(t; L) = \prod_{\tau=t-L+1}^{t} (1 + r_f(\tau)) - 1
]

2. 在最长窗口 `lookback_days_long = 3000` 个交易日内，收集所有可用的 ( R_f(t; L) )，在该样本集合上计算其均值和标准差：

[
\mu_{R,f},\quad \sigma_{R,f}
]

3. 对于当前调仓日 ( t^* )（trade_date），取其对应的滚动收益 ( R_f^* = R_f(t^*; L) ) 并计算 z-score：

[
z_f = \frac{R_f^* - \mu_{R,f}}{\sigma_{R,f}}
]

4. 要求该因子在窗口内的有效样本数不少于 `lookback_days_min = 750` 个交易日，否则认为历史数据不足以判断拥挤度，对该因子不启用风格拥挤调整（视为 ( s_f = 1.0 )，仅打印 warning 日志）。

这样定义的 ( z_f ) 本质上衡量的是：

> “最近 12 个月该因子的收益，相对于过去约 12 年所有 12 个月收益分布，有多极端。”

相比直接使用 NAV 水平，这一指标在统计上更接近平稳量，更适合作为拥挤度度量。

#### 3.2 因子级风险缩放（对 ER 的置信度收缩）

对每个因子 ( f )，根据拥挤度 z-score 计算一个因子级缩放因子 ( s_f )，用于收缩该因子的观点收益率 ( ER_f )。

令：

* 阈值 ( z_0 = 2.0 )（固定，不调参）
* 最小缩放 ( s_{\min} = 0.5 )

记 ( \text{abs}_z = |z_f| )，则：

[
s_f =
\begin{cases}
1, & \text{abs}_z \le z_0 \
\max\left(\dfrac{1}{1 + (\text{abs}*z - z_0)},, s*{\min}\right), & \text{abs}_z > z_0
\end{cases}
]

直观含义：

* 当最近 12 个月的因子表现仍处于历史“正常波动区间”（(|z_f| \le 2)）时，不进行任何缩放：(s_f = 1)。
* 当最近表现进入历史上极端高/极端低区间（(|z_f| > 2)）时，无论是因子多头被挤爆还是反向风格被极端打压，都认为当前 regime 下**对该因子“长期 payoff/stat ER”观点的置信度下降**，因此将 ER 的绝对值向 0 收缩。
* ( s_f ) 的下界为 ( s_{\min} = 0.5 )，避免过度惩罚。

最终，对因子观点的应用方式为：

[
ER_f^{\text{view}} = s_f \cdot ER_f^{\text{base}}
]

其中 ( ER_f^{\text{base}} ) 为原始长期 payoff/stat 估计得到的因子期望收益。
这样：

* 在极端风格 regime 下，既不会显著改变因子方向（多头/空头），
* 又能通过“缩小 ER 绝对值”降低该因子对组合的主导程度，从而**减少组合在该风格上的进攻性暴露**。
* 资产层无需额外改动，因子层的 ER 调整会自然通过 β 映射到所有资产。

---

# 4. 黄金（GOLD）资产风险控制模块

## 4.1 结构性澄清

1. **GOLD 不再作为“因子”参与其他资产的 β 结构。**
2. **黄金 ETF（或黄金指数）是唯一对 GOLD 因子 β=1 的资产。**
3. GOLD 的视图仅影响黄金自身，不影响其他资产。
   → 技术上保持统一，但逻辑上为“单一资产观点”。

## 4.2 黄金的 ER（观点）

黄金观点来自 LLM：

[
ER_{gold} = ER^{LLM}_{gold}
]

mu_prior（人为设定长期值）例如每年 3%。

## 4.3 CFTC 拥挤度（Crowding）

使用标准行业定义：

[
c_t = \frac{\text{non-commercial net long}}{\text{open interest}}
]

## 4.4 经验分位数阈值（因样本不足暂固定）

当前你仅有 2 年 CFTC 数据，不足以估计稳定分布，因此使用黄金市场长期经验值：

* q80 = 0.30
* q95 = 0.36

未来在获取长期历史数据后重新校准。

## 4.5 黄金风险缩放器（简化版）

[
risk_scaler_{gold} =
\begin{cases}
1, & c_t \le q_{80}\
1 + \lambda \cdot \frac{c_t - q_{80}}{q_{95}-q_{80}}, & q_{80}<c_t\le q_{95}\
1 + \lambda, & c_t > q_{95}
\end{cases}
]

建议 λ=1（最大惩罚约 50%）。

在优化器中使用：

[
ER^{final}*{gold} = \frac{ER^{BL}*{gold}}{risk_scaler_{gold}}
]

（此模块属于工程性风险管理，不追求 BL 理论纯度。）

---

# 5. Black–Litterman 集成

## 5.1 视图矩阵构建（简化版）

BL 输入包括：

* 先验：μ_prior, Σ_prior
* 因子观点：ER_MKT, ER_SMB, …, ER_10Y
* 黄金观点：ER_gold
* 观点方差：

  * ω_factor[f]（根据置信度校准）
  * ω_gold（固定为 σ_prior,gold² 或适当放大）
* P：仍为单位矩阵（I）

BL 输出 posterior：

* μ_post
* Σ_post（若使用）

## 5.2 约束与后处理

* 风格拥挤 s_f 对资产 level 的风险预算 / 权重限制生效；
* 黄金 risk_scaler 对黄金资产的 ER 生效；
* 其余资产按 BL 输出正常进入优化器。

---

# 6. 组合优化层（MVO / CVaR）

优化器输入：

* μ_final

  * 由 BL posterior + 风险缩放器整合得到
* Σ

  * 可使用历史协方差或 Kalman 滤波动态估计
* 风格风险缩放 s_f

  * 对高 β_i,f 的资产增加额外风险惩罚
* 单资产权重上限（例如 50%）
* 组合整体杠杆 / 波动目标

V3.0 的关键特性：

### ✔ 黄金不会在拥挤期占到权重上限

（risk_scaler 抑制黄金在“牛市末期 / 多头挤满”状态的爆仓风险）

### ✔ 因子拥挤只影响相关风格，不影响整个 equity

（避免过度惩罚）

### ✔ MKT 和 10YBond 的观点可信度由模型验证 loss 驱动

（模型差 → BL 退回先验 → 风险自然降低）

### ✔ 系统性自由度减少，稳健性显著提高

（删掉 MKT_tech、删掉因子层 ω 调整、删掉多余信号）

---

# 7. 风险警示与局限性说明

本次简化后的体系依然保留部分工程假设，需要在文档中明确说明：

1. **ω 与模型 loss 的映射为工程化模型置信度估计，非严格贝叶斯推导。**
2. GOLD risk_scaler 仅用于防止极端拥挤 regime 下的过度加仓，不用于预测价格。
3. 风格拥挤的阈值（NAV z-score）基于长期经验，未来需根据完整数据重新校准。
4. 因 CFTC 数据样本有限，暂使用行业经验分位数（q80 / q95）。
5. 所有参数均需通过多起点回测、跨周期验证，以避免 overfitting 到单一市场 regime。

---

# 8. 未来版本（V3.1+）可扩展方向

* GOLD risk_scaler 可加入波动率、期限结构、ETF 流量等更高维度指标
* 风格拥挤模型可加入横截面分布特征（如 cross-sectional dispersion）
* MKT 可加入 regime-switching 模型进一步提升置信度估计
* ω 缩放可扩展为随机过程（动态 shrinkage）

---

# ✔ 总结（给项目计划用）

V3.0 通过删除冗余信号、统一 ER 绝对观点、基于模型表现校准 ω、按因子控制拥挤风险，以及为黄金构建简洁稳健的拥挤度 risk_scaler，从整体上提升了系统稳健性、解释性与可扩展性。新的结构更加清晰，避免信息重复使用，同时为未来的多维风险控制留下接口。