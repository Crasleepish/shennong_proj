---

# ✅ 更新后的组合优化方案（修正版）

---

## 🎯 总体目标

构建一个适用于非CAPM市场（如A股）的组合优化系统，融合：

* **因子回归逻辑**（无需市场均衡假设）
* **机器学习预测 α 排序**
* **Kalman Filter 时间加权**
* **贝叶斯后验融合观点**
* **CVaR 优化控制尾部风险**

---

## 📦 数据结构

| 数据源         | 用途                    |
| ----------- | --------------------- |
| ETF 历史收益    | 计算 α & 验证组合表现         |
| 因子历史收益      | 用于预测未来收益率             |
| ETF 因子暴露（β） | 用于构造 μ\_prior 和 μ\_ML |
| 宏观数据        | 做机器学习模型输入特征           |

---

## 🧠 一｜先验收益率（μ\_prior）构造

> 不再使用 BL 中的市场均衡 π
> 而是使用 **ETF 各因子暴露 × 因子历史收益率均值**

### ✅ 处理方式：

$$
\mu_i^{\text{prior}} = \sum_f \beta_{i,f} \cdot \bar{r}_f
$$

* 其中 $\bar{r}_f$ 为因子 $f$ 的历史收益率（可加权平均）

📌 使用 **Kalman Filter** 对 $\bar{r}_f$ 进行**时间加权更新**，提升对当前 regime 的反应：

* 新数据权重大，历史数据衰减；
* 处理噪声扰动，提高时序平滑性。

---

## 🤖 二｜机器学习预测 α 排序

> 使用 XGBoost 回归预测未来 20天的 因子收益率

### ✅ 步骤：

1. **XGBoost 回归模型**预测每个因子 $f$ 的未来收益率 $\hat{r}_f$
2. 对每个资产计算预测值：

   $$
   \hat{\mu}_i^{\text{ML}} = \sum_f \beta_{i,f} \cdot \hat{r}_f
   $$
3. 将 $\hat{\mu}_i^{\text{ML}}$ 排序，形成观点：

   $$
   \text{view rank}(\mu_i)
   $$

📌 不直接使用数值，而是 **将横截面排序作为观点**（排序更稳健，抗尺度漂移）

---

## 🧮 三｜贝叶斯后验融合观点

> 保留 Black–Litterman 的贝叶斯更新框架，但不使用 CAPM 的 π

### ✅ 思路：

* $\mu^{\text{prior}}$：由历史因子收益率 + β × Kalman Filter 构成
* $\hat{\mu}^{\text{ML}}$：由机器学习预测后排序而来，映射为相对观点（Pμ = q）
* 构造观点矩阵 $P$、q、Ω：

  * $P$：比较性矩阵（如 ETF1 > ETF2 → \[1, -1, 0, …]）
  * $q$：排序得分（可设为等间隔 \[0.03, 0.02, …]）
  * $\Omega$：由模型残差、排序稳定性、回测误差构造（非固定值）

> 最终后验：

$$
\mu_{\text{post}} = \left[(\tau\Sigma)^{-1} + P^\top\Omega^{-1}P\right]^{-1}
\left[(\tau\Sigma)^{-1} \mu^{\text{prior}} + P^\top\Omega^{-1} q\right]
$$

---

## 📉 四｜CVaR 优化：风险约束下的收益最优

> 控制尾部风险（98% CVaR ≤ 5%）前提下，最大化期望收益或夏普比率

### ✅ 步骤：

1. 模拟收益场景（历史+随机扰动）
2. 对每个组合权重构造：

   * 损失函数：$L = -w^\top R$
   * CVaR：

     $$
     \text{CVaR}_{\alpha}(w) = \min_{\beta} \left\{ \beta + \frac{1}{1-\alpha} \cdot \mathbb{E}[(L - \beta)^+] \right\}
     $$
3. 优化目标：

   * 最大化 $w^\top \mu_{\text{post}}$
   * s.t. CVaR ≤ κ，long-only, turnover 控制等约束

---

## ✅ 优势总结（修正版）

| 维度            | 优势              |
| ------------- | --------------- |
| 不依赖 CAPM      | 更贴合 A 股/非有效市场环境 |
| 保留贝叶斯结构       | 融合观点 × 控制不确定性   |
| XGBoost 排序    | 稳健、抗漂移，解释性强     |
| CVaR 风控       | 控制尾部风险，符合实盘约束   |
| Kalman Filter | 保留时序信号权重，稳健先验   |
| 模块解耦          | 预测、融合、优化各模块清晰可调 |

---

## **v2.0 方案更新（相对于原 v1.0 项目计划）**

本次更新反映了近期对因子标签体系、收益预测方法、BL 观点结构和黄金资产处理方式的重大调整。以下为新增内容。

---

## **1. 标签（Label）体系更新**

原方案使用 Gaussian 假设 + μ±ασ 作为三分类标签边界。
现替换为：

### ✔ **Rolling 分位数标签**

* 使用 **rolling window（建议 500 天）** 的分位数（20%、50%、80%）对未来 20 日收益率进行划分；
* 自动适应因子收益分布的非平稳性；
* 不再依赖正态分布假设。

> 覆盖的任务：SMB、HML、QMJ、10YBond（用于 ER_stat 部分）

---

## **2. 黄金（GOLD）收益预测重构**

黄金未来收益预测不再使用：

* ML（XGBoost）
* BL（Black–Litterman）

改为：

### ✔ **Rolling 分位数 + LLM 主观判断**

* 使用期货结构（前 6 个高流动性合约 + CASH）与 CFTC 持仓信号；
* 由 LLM 输出“方向性档位”（strong/mild bear/bull/neutral）；
* Rolling 分位数提供 **对应档位的客观收益区间均值**；
* 最终黄金预期收益 **= 纯主观观点输出（LLM → 档位 → ER_roll）**；
* 不进入 BL；黄金被视为 **纯战术资产 / 对冲资产**。

---

## **3. SMB / HML / QMJ 三因子的收益预测重构**

三因子不再训练 ML 模型，因为：

* 技术/量价类特征无法捕捉风格因子；
* ML 泛化性差、过拟合严重；
* 统计特征反而更稳定、更可解释。

现采用：

### ✔ **Rolling 分位数 + 全概率公式 → ER_stat**

步骤：

1. 用 rolling 分位数得到 softprob（P(-), P(0), P(+)）
2. 计算对应三个区间附加衰减权重后的历史未来收益均值（label_to_ret）
3. 全概率公式得到期望收益：

[
ER_{\text{stat}} = \sum_{k} p_k \cdot \text{ret}_k
]

### ✔ ER_stat 作为 BL 的观点 q

* 因为这类因子具有长期风险溢价；
* BL 的先验（长期均衡）与 rolling（局部 regime）融合更稳健。

---

## **4. MKT 因子继续使用 ML**

MKT 模型保持不变：

* 使用 XGBoost 分类；
* softprob → label_to_ret → ER_ml；
* ER_ml 作为 BL 观点（q）；
* 原因：MKT 吸收宏观 regime、波动率 regime，非线性信号更明显。

---

## **5. 10YBond：推出“ML + Rolling”混合框架**

与 SMB/HML/QMJ 不同，10YBond：

* 可预测性更强（ML 有一定 edge）
* 但同时收益结构非常宏观 + regime 变化大，需要统计稳定性

因此改为：

### ✔ **ER_mix = α · ER_ml + (1 – α) · ER_stat**

建议：

* α ∈ [0.2, 0.4]
* ER_ml 捕捉近期非线性
* ER_stat 捕捉中长期 regime 分布特征

### ✔ ER_mix 作为 BL 的观点（q）

---

## **6. Black–Litterman（BL）观点协方差 Ω 的改进**

原 `omega = predicted_factor_variance` 会导致：

* 视图过度自信
* 模型噪声被误认为“预测误差很小”

现更新为：

### ✔ **视图方差 = (放大系数×预测方差) 与先验方差混合**

[
\omega_i = \alpha \cdot \sigma_{\text{prior},i}^2
+ (1 - \alpha) \cdot c \cdot \text{pred_var}_i
]

* 推荐 `c = 3–5`
* 推荐 `α = 0.3–0.6`
* 更合理地衰减 noisy 观点的影响，提高稳定性
